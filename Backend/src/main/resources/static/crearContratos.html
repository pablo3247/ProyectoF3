<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Crear Contrato</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
<h1>Crear Contrato</h1>

<form id="formularioContrato">
  <label for="dniUsuario">Selecciona un usuario por DNI:</label><br>
  <select id="dniUsuario" name="dni" required>
    <option value="">-- Selecciona un DNI --</option>
  </select><br><br>

  <label for="nombreContrato">Nombre del contrato:</label><br>
  <input type="text" id="nombreContrato" name="nombre" required><br><br>

  <label for="archivoPdf">Archivo PDF del contrato:</label><br>
  <input type="file" id="archivoPdf" name="archivoPdf" accept="application/pdf" required><br><br>

  <button type="submit">Crear Contrato</button>
</form>

<p id="mensaje"></p>

<script>
  const token = localStorage.getItem('token');
  if (!token) {
    alert('No estás autenticado. Redirigiendo a login...');
    window.location.href = 'index.html';
  }

  // 1. Cargar usuarios para el select
  fetch('/api/usuarios', {
    headers: {
      'Authorization': 'Bearer ' + token
    }
  })
  .then(response => response.json())
  .then(usuarios => {
    const select = document.getElementById('dniUsuario');
    usuarios.forEach(u => {
      const option = document.createElement('option');
      option.value = u.dni;
      option.textContent = `${u.nombre} (${u.dni})`;
      select.appendChild(option);
    });
  })
  .catch(error => {
    console.error('❌ Error cargando usuarios:', error);
  });

  // 2. Manejar envío del formulario
  document.getElementById('formularioContrato').addEventListener('submit', async function(e) {
    e.preventDefault();

    const dni = document.getElementById('dniUsuario').value;
    const nombre = document.getElementById('nombreContrato').value;
    const archivo = document.getElementById('archivoPdf').files[0];

    if (!archivo) {
      document.getElementById('mensaje').textContent = '❌ Debes seleccionar un archivo PDF.';
      return;
    }

    // Paso 1: asignar contrato en texto
    const respuestaAsignar = await fetch('/api/contratos/asignar', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify({ dni: dni, titulo: nombre, contenido: '' })
    });

    if (!respuestaAsignar.ok) {
      document.getElementById('mensaje').textContent = '❌ Error al asignar contrato.';
      return;
    }

    const texto = await respuestaAsignar.text();
    const idContrato = texto.match(/contrato con DNI.*?(\d+)/i)?.[1]; // opcional si API lo permite

    // Paso 2: subir archivo PDF
    const subir = await fetch(`/api/contratos/${idContrato}/subir-pdf`, {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + token
      },
      body: (() => {
        const form = new FormData();
        form.append('file', archivo);
        return form;
      })()
    });

    if (subir.ok) {
      document.getElementById('mensaje').textContent = '✅ Contrato creado correctamente.';
    } else {
      document.getElementById('mensaje').textContent = '❌ Error al subir el PDF.';
    }
  });
</script>
</body>
</html>
